# ###########################################
# Setup Configuration
# ###########################################
env_cfg:
  run_name: elir-llie-sid-phy
  project_name: elir-llie
  task: llie
  out_dir: /tmp/out_dir
  seed: 2025


# -------------------------------------------------
# Dataset
# -------------------------------------------------
dataset_cfg:
  train_dataset: { name: SID,
                   path: /tmp/sid_phy_dedup/train,
                   task: llie,
                   batch_size: 32,
                   patch_size: 256,
                   num_workers: 16,
                   random_crop: true,
                   augment: true,
                   amplification_ratio: 1,
                   raw_processing_mode: basic,
                   shuffle: true}
  val_datasets:
    - { name: SID,
        path: /tmp/sid_phy_dedup/test_x300,
        task: llie,
        batch_size: 16,
        patch_size: 256,
        num_workers: 16,
        random_crop: false,
        shuffle: false,
        full_image: true,      # Use entire images for validation
        amplification_ratio: 300, # not in use, for clarity
        raw_processing_mode: full

    }
    - { name: SID,
        path: /tmp/sid_phy_dedup/test_x250,
        task: llie,
        batch_size: 16,
        patch_size: 256,
        num_workers: 16,
        random_crop: false,
        shuffle: false,
        full_image: true,      # Use entire images for validation
        amplification_ratio: 250,
        raw_processing_mode: full
    }
    - { name: SID,
        path: /tmp/sid_phy_dedup/test_x100,
        task: llie,
        batch_size: 16,
        patch_size: 256,
        num_workers: 16,
        random_crop: false,
        shuffle: false,
        full_image: true,      # Use entire images for validation
        amplification_ratio: 100,
        raw_processing_mode: full
    }

# -------------------------------------------------
# Flow-Matching
# -------------------------------------------------
fm_cfg:
  method: l2_cfm_mse_loss
  k_steps: 5
  t_emb_dim: 160
  sigma_min: 0.00001
  sigma_s: 0.025
  dt: 0.05
  alpha: 0.001
  beta: 0.001


# -------------------------------------------------
# Model
# -------------------------------------------------
model_cfg:
  arch_cfg: {name: elir,
             params: { fm_cfg: {k_steps: 3, sigma_s: 0.025, latent_shape: [16,32,32], seed: 2025},
                      fmir_cfg: {name: lunet,
                                params: {ch_mult: [1,2,1,2], n_mid_blocks: 1, in_channels: 16, hid_channels: 128, out_channels: 16,
                                         t_emb_dim: 160, overparametrization: True},
                                trainable: True},
                      mmse_cfg: {name: rrdbnet,
                                params: {c_inout: 16, c_hid: 96, n_rrdb: 3, overparametrization: True},
                                trainable: True},
                      enc_cfg: {name: tiny_enc,
                                trainable: True},
                      dec_cfg: {name: tiny_dec,
                                trainable: False}}}

  teacher_cfg: {name: taesd,
                params: { },
                trainable: False}

# -------------------------------------------------
# Training
# -------------------------------------------------
train_cfg:
  epochs: 250
  optimizer: !name:torch.optim.AdamW
  lr: 0.0002
  weight_decay: 0.0
  optimizer_params: {}
  ema_decay: 0.999
  max_steps: -1 # run only several steps
  check_val_every_n_epoch: 1
  num_sanity_val_steps: 2
  wandb: False
  mlflow: True
  mlflow_tracking_uri: ./mlruns
  # Image logging mode for validation samples:
  #   "none"  - don't save validation images
  #   "local" - save to local samples folder (default)
  #   "mlflow" - save locally AND log to MLflow artifacts
  # Note: input/ground_truth saved once (first epoch), predictions saved every epoch
  image_logging_mode: local



# -------------------------------------------------
# Evaluation
# -------------------------------------------------
eval_cfg:
  metrics: ["lpips","psnr", "fid"]
